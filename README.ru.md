# codex-workspace-emulator

`codex-workspace-emulator` — локальная реплика базового образа, который используется в Codex Workspace. Она позволяет собирать и запускать окружение целиком на вашей машине при помощи Docker Compose и повторяет ключевые ограничения оригинальной среды:

- Образ собирается локально под тегом `codex-workspace-emulator:latest`.
- В контейнер попадают только файлы, зафиксированные в git (состояние HEAD).
- setup-скрипты могут прогревать образ и запускаться повторно из закешированного слоя.
- Весь исходящий трафик проходит через встроенный MITM-прокси и должен быть HTTPS; WebSocket и прямые подключения блокируются.

## Требования

- Docker 24.0+ с плагином Compose.
- Доступ к репозиторию, содержащему каталог `.git`.
- GNU coreutils (для `realpath`) или Python 3 — скрипт запуска использует `python3`, если `realpath` недоступен.

## Быстрый старт

```bash
./scripts/run-workspace.sh /путь/к/вашему/репозиторию
```

Сценарий выполняет следующие шаги:

1. Собирает `codex-workspace-emulator:latest`, если он отсутствует.
2. Запускает сервис `mitmproxy` и контейнер `workspace` через Docker Compose.
3. Копирует в `/workspace/project` только файлы из `HEAD` (совпадающие с состоянием git).
4. Если в проекте есть `codex-workspace-scripts/setup-script.sh`, скрипт выполняется в изолированном контейнере. При успешном завершении и наличии `setup-from-cache-script.sh` создаётся снапшот `codex-workspace-emulator:cached`, после чего запускается второй контейнер для «cache hit» сценария.
5. Если setup-скрипты отсутствуют, вы попадаете в интерактивную bash-сессию с уже настроенными языковыми средами.

Путь к репозиторию можно не передавать — скрипт использует текущий каталог по умолчанию.

## Проекция репозитория

- В контейнер монтируется только `.git` (read-only).
- Точка входа копирует `.git` во внутренний каталог и делает `git reset --hard HEAD`, синхронизируя чистую рабочую директорию.
- Подмодули обновляются рекурсивно (можно отключить через `CODEX_SKIP_SUBMODULES=1`).
- Любые изменения внутри контейнера не попадают обратно в ваш рабочий каталог.

Такое поведение соответствует тому, как Codex формирует рабочее окружение из коммита.

## Контракт setup-скриптов

Если в корне репозитория присутствует `codex-workspace-scripts/`:

- `setup-script.sh` — **обязательный** файл. Запускается в «чистом» контейнере и может устанавливать пакеты, скачивать зависимости и т.д.
- `setup-from-cache-script.sh` — **опциональный**. Если он есть, после выполнения первого скрипта контейнер сохраняется `docker commit` в `codex-workspace-emulator:cached`, затем запускается второй скрипт уже на закешированном образе.
- Когда каталог со скриптами есть, контейнеры выполняются до конца и завершаются; интерактивной сессии по умолчанию нет.

Вывод обоих скриптов полностью транслируется в консоль. Ненулевой код завершения останавливает процесс и сохраняет логи.

## Ограничения сети и прокси

Compose-файл объявляет два сервиса:

- `proxy` — `mitmdump` с кастомным скриптом, разрешающим только HTTPS и блокирующим WebSocket. Он хранит сгенерированный корневой сертификат в общей volume.
- `workspace` / `workspace-cache` — контейнеры с образом Codex. Они подключены только к внутренней сети Docker и могут выходить в Интернет исключительно через `proxy`.

В контейнерах выставлены те же переменные окружения, что и в Codex (`HTTP_PROXY=http://proxy:8080`, `NO_PROXY=localhost,127.0.0.1,::1`, `NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/envoy-mitmproxy-ca-cert.crt` и др.). При старте entrypoint ждёт появления сертификата прокси, устанавливает его в системное хранилище и выставляет `REQUESTS_CA_BUNDLE`, `SSL_CERT_FILE`, `PIP_CERT` и т.п.

Поскольку контейнеры находятся во внутренней сети, любые попытки обойти прокси блокируются. Прокси-скрипт также отклоняет WebSocket (`wss`) соединения, оставляя только HTTPS.

## Ручное управление через docker-compose

```bash
export HOST_REPO=$(pwd)
export HOST_REPO_NAME=$(basename "$HOST_REPO")

# Сборка образа
docker compose build workspace

# Интерактивный запуск без setup-скриптов
docker compose run --rm workspace

# Запуск setup-скриптов вручную
docker compose run --name codex-setup workspace run-setup
docker commit codex-setup codex-workspace-emulator:cached
docker rm codex-setup
docker compose run --rm workspace-cache run-setup-from-cache

docker compose down --remove-orphans
```

Скрипт `scripts/run-workspace.sh` автоматизирует эти шаги, включая очистку контейнеров и управление кешем.

### Тестовый проект

Для проверки всей цепочки запустите smoke-тест:

```bash
./tests/run-example-tests.sh
```

Он заново инициализирует временный git-репозиторий в `tests/example-project`, выполняет оба setup-скрипта и убеждается, что:
- в рабочий каталог попадают только файлы из коммита
- через прокси проходят только HTTPS-запросы, а HTTP, WebSocket и прямые подключения блокируются
- состояние, созданное `setup-script.sh`, сохраняется в слепке для `setup-from-cache-script.sh`

## Настройки окружения

При старте контейнера задаются следующие значения (их можно переопределять в Compose или через переменные среды):

| Переменная | Значение |
| ---------- | -------- |
| `CODEX_ENV_PYTHON_VERSION` | `3.12` |
| `CODEX_ENV_NODE_VERSION` | `20` |
| `CODEX_ENV_RUST_VERSION` | `1.89.0` |
| `CODEX_ENV_GO_VERSION` | `1.24.3` |
| `CODEX_ENV_SWIFT_VERSION` | `6.1` |
| `CODEX_ENV_RUBY_VERSION` | `3.4.4` |
| `CODEX_ENV_PHP_VERSION` | `8.4` |
| `CODEX_ENV_BUN_VERSION` | `1.2.14` |
| `CODEX_ENV_JAVA_VERSION` | `21` |

При необходимости указывайте свои значения: `docker compose run -e CODEX_ENV_NODE_VERSION=22 workspace …`.

## Диагностика

- **Переменная HOST_REPO не установлена** — экспортируйте `HOST_REPO` (и при желании `HOST_REPO_NAME`) перед запуском `docker compose run`, либо используйте `./scripts/run-workspace.sh`.
- **Не найден сертификат mitmproxy** — убедитесь, что сервис `proxy` запущен и здоров; entrypoint ждёт сертификат до 30 секунд.
- **Сбой setup-скрипта** — сценарий останавливается на первой ошибке. Исправьте скрипт и повторите запуск; кеш перезаписывается только после успешного выполнения.
- **Нужно пропустить подмодули** — запустите `CODEX_SKIP_SUBMODULES=1 ./scripts/run-workspace.sh`.

## Лицензия

См. [LICENSES](LICENSES) из оригинального проекта.
